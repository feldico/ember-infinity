{"version":3,"file":"infinity.js","sources":["../../src/services/infinity.js"],"sourcesContent":["import Service from '@ember/service';\nimport InfinityModel from '../lib/infinity-model';\nimport InfinityPromiseArray from '../lib/infinity-promise-array';\nimport { getOwner } from '@ember/application';\nimport { get } from '@ember/object';\nimport { A } from '@ember/array';\nimport { typeOf } from '@ember/utils';\nimport { scheduleOnce } from '@ember/runloop';\nimport {\n  checkInstanceOf,\n  convertToArray,\n  objectAssign,\n  paramsCheck,\n} from '../utils';\nimport { assert } from '@ember/debug';\nimport { resolve } from 'rsvp';\n\n/**\n * { 'products': { future_timestamp: infinityModel } }\n * contains an array of Array Proxies\n * only called when need to re-cache the collection\n *\n * @method cacheInfinityCollection\n * @param Ember.Array _cachedCollection\n * @param Object infinityModel\n * @param String identifier\n * @param String timestamp\n * @return Object\n */\nlet cacheInfinityCollection = (\n  _cachedCollection,\n  infinityModel,\n  identifier,\n  timestamp\n) => {\n  if (_cachedCollection && _cachedCollection[identifier]) {\n    // 1. first clear out elements from object since we are expired\n    _cachedCollection[identifier] = {};\n  }\n\n  // 2. Set new timestamp for identifier\n  let future_timestamp = new Date().getTime() + timestamp;\n  return (_cachedCollection[identifier] = {\n    [future_timestamp]: infinityModel,\n  });\n};\n\nconst ALLOWED_KEYS = [\n  'perPage',\n  'perPageParam',\n  'startingPage',\n  'firstPage',\n  'totalPagesParam',\n  'countParam',\n  'infinityCache',\n  'filter',\n  'storeFindMethod',\n  'meta',\n];\n\n/**\n * @method stringifyObjectValues\n * @param Object options\n * @param String identifier\n * @return String\n */\nlet stringifyObjectValues = (options, identifier = '') => {\n  return Object.keys(options)\n    .filter((key) => {\n      return (\n        ALLOWED_KEYS.indexOf(key) > -1 ||\n        typeof options[key] === 'string' ||\n        typeof options[key] === 'number' ||\n        typeof options[key] === 'boolean'\n      );\n    })\n    .reduce((acc, key) => {\n      const value = options[key];\n      if (!!value && typeof value === 'object') {\n        return stringifyObjectValues(value, acc);\n      }\n\n      return (acc += '' + value);\n    }, identifier);\n};\n\nexport default class Infinity extends Service {\n  /**\n    Data fetching/caching service pull off of user's route\n    Optional for end user to have ember-data\n\n    @public\n    @property store\n    @type Ember.Service\n  */\n  get store() {\n    if (this._store) {\n      return this._store;\n    }\n\n    return getOwner(this).lookup('service:store') || class extends Service {};\n  }\n  set store(value) {\n    this._store = value;\n  }\n\n  /**\n    Internal reference to manage collection throughout lifecycle of service\n\n    @public\n    @property infinityModels\n    @type Ember.Service\n  */\n  infinityModels;\n\n  /**\n    @private\n    @property _previousScrollHeight\n    @type Integer\n    @default 0\n  */\n  _previousScrollHeight = 0;\n\n  constructor(...args) {\n    super(...args);\n\n    this._cachedCollection = {};\n    this.infinityModels = A();\n  }\n\n  /**\n    @method pushObjects\n    @param {EmberInfinity.InfinityModel} infinityModel\n    @param {Array} queryObject - list of Store models\n   */\n  pushObjects(infinityModel, queryObject) {\n    if (checkInstanceOf(infinityModel)) {\n      return infinityModel.pushObjects(convertToArray(queryObject));\n    }\n  }\n\n  /**\n    @method unshiftObjects\n    @param {EmberInfinity.InfinityModel} infinityModel\n    @param {Array} queryObject - list of Store models\n   */\n  unshiftObjects(infinityModel, queryObject) {\n    if (checkInstanceOf(infinityModel)) {\n      return infinityModel.unshiftObjects(convertToArray(queryObject));\n    }\n  }\n\n  /**\n    - Useful for updating the infinity model with a new array\n    - For example, you fetch a new array from your backend based on search criteria and need to swap out what currently\n    exists with what was returned from your query\n    - HOWEVER, note this method can be particularly dangerous, for example, when using to filter a list.  If you are not using queryParams or\n    some other sort of state that is passed to your model hook, when your component goes to fetch the next page of documents, it will not include\n    the filter param.  This will lead to a list that partly does not represent what the user filtered.\n\n    @method replace\n    @param {EmberInfinity.InfinityModel} infinityModel\n    @param newCollection - Ember Data (or similar store) response\n   */\n  replace(infinityModel, newCollection) {\n    if (checkInstanceOf(infinityModel)) {\n      const len = infinityModel.length;\n      infinityModel.replace(0, len, convertToArray(newCollection));\n      return infinityModel;\n    }\n  }\n\n  /**\n    Useful for clearing out the collection\n\n    @method flush\n    @param {EmberInfinity.InfinityModel} infinityModel\n   */\n  flush(infinityModel) {\n    if (checkInstanceOf(infinityModel)) {\n      const len = infinityModel.length;\n      infinityModel.replace(0, len, []);\n      return infinityModel;\n    }\n  }\n\n  /**\n    Trigger a load of the next page of results while also checking if it can load more\n    Subsequent fetching.  Not used for initial request\n\n    @public\n    @method infinityLoad\n    @param {EmberInfinity.InfinityModel} infinityModel\n    @param {Integer} increment - to increase page by 1 or -1\n   */\n  infinityLoad(infinityModel, increment = 1) {\n    if (!infinityModel) {\n      return resolve();\n    }\n\n    infinityModel = this.infinityModels.find(\n      (model) => model === infinityModel\n    );\n    let result;\n    if (infinityModel) {\n      // this is duplicated if this method is called from the route.\n      infinityModel._increment = increment;\n\n      if (infinityModel.loadingMore || !infinityModel.canLoadMore) {\n        return resolve();\n      }\n\n      result = this.loadNextPage(infinityModel, increment);\n    } else {\n      result = true;\n    }\n    return resolve(result);\n  }\n\n  /**\n    Use the model method in the place of `this.store.query('model')` to\n    initialize the Infinity Model for your route.\n    Main method used for initial load of infinity collection in route or top level component\n\n    @method model\n    @param {String} modelName The name of the model.\n    @param {Object} options - optional - the perPage and startingPage to load from.\n    @param {Object} ExtendedInfinityModel - optional -\n      params on route to be looked up on every route request or\n      instance of InfinityModel\n    @return {Ember.RSVP.Promise}\n  */\n  model(modelName, options, ExtendedInfinityModel) {\n    if (typeOf(ExtendedInfinityModel) === 'class') {\n      if (!(ExtendedInfinityModel.prototype instanceof InfinityModel)) {\n        throw new Error(\n          'Ember Infinity: You must pass an Infinity Model instance as the third argument'\n        );\n      }\n    }\n\n    if (!modelName) {\n      throw new Error(\n        'Ember Infinity: You must pass a Model Name to infinityModel'\n      );\n    }\n\n    options = options ? objectAssign({}, options) : {};\n\n    if (options.store) {\n      this._ensureCustomStoreCompatibility(\n        options,\n        options.store,\n        options.storeFindMethod || 'query'\n      );\n    }\n\n    // default is to start at 0, request next page and increment\n    const currentPage =\n      options.startingPage === undefined ? 0 : options.startingPage - 1;\n    // sets first page when route is loaded\n    const firstPage = currentPage === 0 ? 1 : currentPage + 1;\n    // chunk requests by indicated perPage param\n    const perPage = options.perPage || 25;\n\n    // store service methods (defaults to ember-data if nothing passed)\n    const store = options.store || this.store;\n    const storeFindMethod = options.storeFindMethod || 'query';\n\n    let InfinityModelInstance, infinityModelForParamsCheck;\n    if (ExtendedInfinityModel) {\n      // if custom InfinityModel, then use as base for creating an instance\n      InfinityModelInstance = ExtendedInfinityModel;\n      infinityModelForParamsCheck = ExtendedInfinityModel.create();\n    } else {\n      InfinityModelInstance = InfinityModel;\n      infinityModelForParamsCheck = InfinityModel.create();\n    }\n\n    // check if user passed in param w/ infinityModel, else default\n    const perPageParam = paramsCheck(\n      'perPageParam',\n      options,\n      infinityModelForParamsCheck\n    );\n    const pageParam = paramsCheck(\n      'pageParam',\n      options,\n      infinityModelForParamsCheck\n    );\n    const totalPagesParam = paramsCheck(\n      'totalPagesParam',\n      options,\n      infinityModelForParamsCheck\n    );\n    const countParam = paramsCheck(\n      'countParam',\n      options,\n      infinityModelForParamsCheck\n    );\n    const infinityCache = paramsCheck(\n      'infinityCache',\n      options,\n      infinityModelForParamsCheck\n    );\n\n    // preContent, content, and meta are OPTIONAL, These allow to initialize\n    // the infinity model with a pre-existing array of objects, the best use case\n    // so far would be the data on a shoebox, coming from ember-fastBoot. This way, we\n    // avoid having a second request to the server, and we also maintain the logic\n    // of the infinity model, the current content, the meta, which makes requesting\n    // the next page, or the previous page, or any other action, CONSISTENT.\n\n    const preContent = A(paramsCheck(\n      'preContent',\n      options,\n      infinityModel\n    )) || A()\n    const content = A(paramsCheck(\n      'content',\n      options,\n      infinityModel\n    )) || A()\n    const meta = paramsCheck(\n      'meta',\n      options,\n      infinityModel\n    ) || {}\n\n    // create identifier for use in storing unique cached infinity model\n    let identifier = stringifyObjectValues(options);\n\n    delete options.startingPage;\n    delete options.perPage;\n    delete options.perPageParam;\n    delete options.pageParam;\n    delete options.totalPagesParam;\n    delete options.countParam;\n    delete options.infinityCache;\n    delete options.store;\n    delete options.storeFindMethod;\n    delete options.preContent;\n    delete options.content;\n    delete options.meta;\n\n    const initParams = {\n      container: getOwner(this),\n      currentPage,\n      firstPage,\n      perPage,\n      perPageParam,\n      pageParam,\n      totalPagesParam,\n      countParam,\n      extraParams: options,\n      _infinityModelName: modelName,\n      store,\n      storeFindMethod,\n      content: A(),\n      preContent,\n      meta\n    };\n\n    for (let key in initParams) {\n      if (typeof initParams[key] === 'undefined') {\n        delete initParams[key];\n      }\n    }\n\n    const infinityModel = InfinityModelInstance.create(initParams);\n    this._ensureCompatibility(\n      infinityModel.store,\n      infinityModel.storeFindMethod\n    );\n\n    // route specific (for backwards compat)\n    this.infinityModels.pushObject(infinityModel);\n\n    // internal service specific\n    if (infinityCache) {\n      assert(\n        'timestamp must be a positive integer in milliseconds',\n        infinityCache > 0\n      );\n\n      // 1. create identifier for storage in _cachedCollection\n      const uniqueIdentifier = (modelName += identifier);\n      const _cachedCollection = this._cachedCollection;\n      const cachedModel = _cachedCollection[uniqueIdentifier];\n      if (cachedModel) {\n        // 2. If cachedModel, get future_timestamp (ms since 1970) and compare to now\n        const future_timestamp = Object.keys(cachedModel)[0];\n        if (future_timestamp > Date.now()) {\n          return cachedModel[future_timestamp];\n        } else {\n          // 3. cache collection based on new timestamp\n          cacheInfinityCollection(\n            _cachedCollection,\n            infinityModel,\n            uniqueIdentifier,\n            infinityCache\n          );\n        }\n      } else {\n        // 2. if we are expired (future_timestamp < Date.now()) or cachedModel doesn't exist, cache a new infinityModel + future timestamp\n        cacheInfinityCollection(\n          _cachedCollection,\n          infinityModel,\n          uniqueIdentifier,\n          infinityCache\n        );\n      }\n    }\n\n    return InfinityPromiseArray.create({\n      promise: this.loadNextPage(infinityModel),\n    });\n  }\n\n  /**\n    load the next page from the adapter and update the model\n    set current height of elements.  If loadPrevious, we will use this value to scroll back down the page\n\n    @public\n    @method loadNextPage\n    @param {EmberInfinity.InfinityModel} infinityModel\n    @param {Integer} increment - to increase page by 1 or -1. Default to increase by one page\n    @return {Ember.RSVP.Promise} A Promise that resolves the model\n   */\n  loadNextPage(infinityModel, increment = 1) {\n    infinityModel.isLoaded = false;\n    infinityModel.loadingMore = true;\n    this._previousScrollHeight = this._calculateHeight(infinityModel);\n\n    return this._requestNextPage(infinityModel, increment)\n      .then((newObjects) => this._afterInfinityModel(newObjects, infinityModel))\n      .then((newObjects) => this._doUpdate(newObjects, infinityModel))\n      .then((infinityModel) => {\n        if (increment === 1) {\n          // scroll down to load next page\n          infinityModel.incrementProperty('currentPage');\n        } else {\n          if (typeof FastBoot === 'undefined') {\n            let viewportElem = infinityModel._scrollable\n              ? document.querySelector(infinityModel._scrollable)\n              : document.scrollingElement || document.documentElement;\n\n            scheduleOnce('afterRender', this, '_updateScrollTop', {\n              infinityModel,\n              viewportElem,\n            });\n            // scrolled up to load previous page\n            infinityModel.decrementProperty('currentPage');\n          }\n        }\n\n        infinityModel._firstPageLoaded = true;\n        const canLoadMore = infinityModel.canLoadMore;\n        infinityModel.reachedInfinity = !canLoadMore;\n\n        if (!canLoadMore) {\n          this._notifyInfinityModelLoaded(infinityModel);\n        }\n\n        return infinityModel;\n      })\n      .catch((e) => {\n        infinityModel.isError = true;\n        throw e;\n      })\n      .finally(() => (infinityModel.loadingMore = false));\n  }\n\n  /**\n    calculate the height of the scrollable viewport\n\n    @private\n    @method _calculateHeight\n    @param {Object} infinityModel\n    @return Integer\n   */\n  _calculateHeight(infinityModel) {\n    if (typeof FastBoot === 'undefined') {\n      const isScrollable = !!infinityModel._scrollable;\n      const viewportElem = isScrollable\n        ? document.querySelector(infinityModel._scrollable)\n        : document.documentElement;\n      return viewportElem.scrollHeight;\n    }\n  }\n\n  /**\n    This method calculates the difference if loadPrevious=true\n    The browser by default will scroll to the top of the element list when the previous page\n    loads.  As a result, we need to scroll back down the page.\n    The math behind this is as follows:\n    (height after loading previous elems) - (old height)\n    So 150px - 100px === 150px\n    178px - 100px = 78px\n    120px - 10px = 110px\n    @private\n    @method _updateScrollTop\n    @return Integer\n   */\n  _updateScrollTop({ infinityModel, viewportElem }) {\n    let scrollDiff =\n      this._calculateHeight(infinityModel) - this._previousScrollHeight;\n    viewportElem.scrollTop += scrollDiff;\n  }\n\n  /**\n    request the next page from the adapter\n\n    @private\n    @method _requestNextPage\n    @param {EmberInfinity.InfinityModel} infinityModel\n    @param {String} increment\n    @returns {Ember.RSVP.Promise} A Promise that resolves the next page of objects\n   */\n  _requestNextPage(infinityModel, increment) {\n    const modelName = infinityModel._infinityModelName;\n    const params = infinityModel.buildParams(increment);\n\n    if (infinityModel.onRequestNextPage) {\n      return infinityModel.onRequestNextPage(\n        infinityModel,\n        modelName,\n        params\n      );\n    }\n\n    return infinityModel.store[infinityModel.storeFindMethod](\n      modelName,\n      params\n    );\n  }\n\n  /**\n    set _totalPages && count param on infinityModel\n    Update the infinity model with new objects with either adding to end or start of Array of objects\n\n    @private\n    @method _doUpdate\n    @param {Ember.Enumerable} queryObject The new objects to add to the model\n    @param {EmberInfinity.InfinityModel} infinityModel\n    @return {Ember.Array} returns the new objects\n   */\n  _doUpdate(queryObject, infinityModel) {\n    infinityModel.isLoaded = true;\n\n    const totalPages = get(queryObject, infinityModel.totalPagesParam);\n    const count = get(queryObject, infinityModel.countParam);\n    infinityModel._totalPages = totalPages;\n    infinityModel._count = count;\n    infinityModel.meta = queryObject.meta;\n\n    let newObjects;\n    if (infinityModel.get('_increment') === 1) {\n      newObjects = infinityModel.pushObjects(queryObject.slice());\n    } else {\n      newObjects = infinityModel.unshiftObjects(queryObject.slice());\n    }\n\n    this._notifyInfinityModelUpdated(queryObject, infinityModel);\n\n    return newObjects;\n  }\n\n  /**\n    finish the loading cycle by notifying that infinity has been reached\n\n    @private\n    @method _notifyInfinityModelLoaded\n    @param {EmberInfinity.InfinityModel} infinityModel\n   */\n  _notifyInfinityModelLoaded(infinityModel) {\n    function loaded() {\n      infinityModel.infinityModelLoaded({ totalPages: this.totalPages });\n      infinityModel.trigger('infinityModelLoaded');\n    }\n    scheduleOnce('afterRender', this, loaded);\n  }\n\n  /**\n    finish the loading cycle by notifying that infinity has been updated\n\n    @private\n    @method _notifyInfinityModelUpdated\n    @param {Array} queryObject\n    @param {EmberInfinity.InfinityModel} infinityModel\n   */\n  _notifyInfinityModelUpdated(queryObject, infinityModel) {\n    const totalPages = infinityModel._totalPages;\n    const lastPageLoaded = infinityModel.currentPage;\n    scheduleOnce('afterRender', infinityModel, 'infinityModelUpdated', {\n      lastPageLoaded,\n      totalPages,\n      queryObject,\n    });\n  }\n\n  /**\n    hook to modify results from response\n\n    @private\n    @method _afterInfinityModel\n   */\n  _afterInfinityModel(newObjects, infinityModel) {\n    const result = infinityModel.afterInfinityModel(newObjects, infinityModel);\n    if (result) {\n      return result;\n    }\n    return newObjects;\n  }\n\n  /**\n    If pass in custom store, ensure passed string\n    Ensure query method exists, otherwise pass method (that returns a promise) in as storeFindMethod in options\n\n    @method _ensureCustomStoreCompatibility\n    @param {Option} options\n  */\n  _ensureCustomStoreCompatibility(options, store, storeFindMethod) {\n    if (!store[storeFindMethod]) {\n      throw new Error(\n        'Ember Infinity: Custom data store must specify query method'\n      );\n    }\n  }\n\n  /**\n    Determine if Ember data is valid\n    Ensure _store is set on route with a query method\n    Ensure model passed to infinity model\n\n    @method _ensureCompatibility\n  */\n  _ensureCompatibility(store, storeFindMethod) {\n    if (!store || !store[storeFindMethod]) {\n      throw new Error(\n        'Ember Infinity: Store is not available to infinity.model'\n      );\n    }\n  }\n}\n"],"names":["cacheInfinityCollection","_cachedCollection","infinityModel","identifier","timestamp","future_timestamp","Date","getTime","ALLOWED_KEYS","stringifyObjectValues","options","Object","keys","filter","key","indexOf","reduce","acc","value","Infinity","Service","store","_store","getOwner","lookup","constructor","args","_defineProperty","infinityModels","A","pushObjects","queryObject","checkInstanceOf","convertToArray","unshiftObjects","replace","newCollection","len","length","flush","infinityLoad","increment","resolve","find","model","result","_increment","loadingMore","canLoadMore","loadNextPage","modelName","ExtendedInfinityModel","typeOf","prototype","InfinityModel","Error","objectAssign","_ensureCustomStoreCompatibility","storeFindMethod","currentPage","startingPage","undefined","firstPage","perPage","InfinityModelInstance","infinityModelForParamsCheck","create","perPageParam","paramsCheck","pageParam","totalPagesParam","countParam","infinityCache","preContent","meta","content","initParams","container","extraParams","_infinityModelName","_ensureCompatibility","pushObject","assert","uniqueIdentifier","cachedModel","now","InfinityPromiseArray","promise","isLoaded","_previousScrollHeight","_calculateHeight","_requestNextPage","then","newObjects","_afterInfinityModel","_doUpdate","incrementProperty","FastBoot","viewportElem","_scrollable","document","querySelector","scrollingElement","documentElement","scheduleOnce","decrementProperty","_firstPageLoaded","reachedInfinity","_notifyInfinityModelLoaded","catch","e","isError","finally","isScrollable","scrollHeight","_updateScrollTop","scrollDiff","scrollTop","params","buildParams","onRequestNextPage","totalPages","get","count","_totalPages","_count","slice","_notifyInfinityModelUpdated","loaded","infinityModelLoaded","trigger","lastPageLoaded","afterInfinityModel"],"mappings":"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"}